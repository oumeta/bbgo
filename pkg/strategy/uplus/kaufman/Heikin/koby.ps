//@version=3

//https://www.tradingview.com/script/dRpY1MbT/

///////////////////////////////////////////
//----------- study and input -----------//
//---------------------------------------//
//---------------------------------------//
study(title="Koby's 3 average MACD indicator", shorttitle="K3a_MACD", overlay=false)
lenF = input(title="Fast length", defval=12, minval=1)
lenS = input(title="Slow length", defval=26, minval=2)
lensig = input(title="Signal length", defval=9, minval=1)
kamalenF = input(title="Fast length for KAMA", type=integer, defval=2)
kamalenS = input(title="Slow length for KAMA", type=integer, defval=30)
mult = input(title="Long term multiple", type=integer, defval=6)
src = input(title="Source", defval=hlc3)
select = input(title="Use EMA singnal", type=bool, defval=false)
select_kama = input(title="Use KAMA MACD", type=bool, defval=false)
//---------------------------------------//
//---------------------------------------//
//---------------------------------------//
///////////////////////////////////////////



///////////////////////////////////////////
//---------------------------------------//
//---------- Zero Lag EMA MACD ----------//
//---------------------------------------//
//------------  Fast ZLEMA  -------------//
//---------------------------------------//
Flag = (lenF - 1) / 2
Fdata = src + (src - src[Flag])
fast = ema(Fdata, lenF)
//Slow ZLEMA
Slag = (lenS - 1) / 2
Sdata = src + (src - src[Slag])
slow = ema(Sdata, lenS)
//MACD
macd1 = fast - slow
//---------------------------------------//
//---------------------------------------//
//---------------------------------------//
///////////////////////////////////////////



/////////////////////////////////////
//---------------------------------//
//---------- Normal MACD ----------//
//---------------------------------//
//----------  Fast EMA  -----------//
//---------------------------------//
emaF = ema(src, lenF)
//----------  Slow EMA  -----------//
emaS = ema(src, lenS)
//------------ - MACD  ------------//
macd2 = emaF - emaS
//---------------------------------//
//---------------------------------//
//---------------------------------//
/////////////////////////////////////



///////////////////////////////////
//-------------------------------//
//---------- KAMA MACD ----------//
//-------------------------------//
//---------- volatility ---------//
//-------------------------------//
vola1 = sum(abs(src - src[1]), lenF)
//-------------------------------//
//------- Efficiency Ratio ------//
//-------------------------------//
er1 = vola1 != 0 ? abs(src - src[lenF]) / vola1 : 0
//-------------------------------//
//---------- Fast KAMA ----------//
//-------------------------------//
kamaF = 0.0
kamaF:= nz(kamaF[1]) + pow(er1 * (2 / (kamalenF + 1) - 2 / (kamalenS + 1)) + 2 / (kamalenS + 1), 2) * (src - nz(kamaF[1]))
//-------------------------------//
//---------- volatility ---------//
//-------------------------------//
vola2 = sum(abs(src - src[1]), lenS)
//-------------------------------//
//------- Efficiency Ratio ------//
//-------------------------------//
er2 = vola2 != 0 ? abs(src - src[lenS]) / vola2 : 0
//-------------------------------//
//---------- Slow KAMA ----------//
//-------------------------------//
kamaS = 0.0
kamaS:= nz(kamaS[1]) + pow(er2 * (2 / (kamalenF + 1) - 2 / (kamalenS + 1)) + 2 / (kamalenS + 1), 2) * (src - nz(kamaS[1]))
//-------------------------------//
//------------- MACD ------------//
//-------------------------------//
macd3 = kamaF - kamaS
//-------------------------------//
//-------------------------------//
//-------------------------------//
///////////////////////////////////



/////////////////////////////////////
//---------------------------------//
//---------- calculation ----------//
//---------------------------------//
//-----------  macdavg  -----------//
//---------------------------------//
macdavg = select_kama ? macd3 : (macd1 + macd2 + macd3) / 3
//---------------------------------//
//-----------   0 line   ----------//
//---------------------------------//
hline(0, title="0 line", color=#99FF99, linestyle=dashed)
//---------------------------------//
//---------- Normal MACD ----------//
//---------------------------------//
ema_macd = ema(src, lenF) - ema(src, lenS)
//---------------------------------//
//------------  signal  -----------//
//---------------------------------//
signal = select ? ema(macdavg, lensig) : ema(macdavg + (macdavg - macdavg[(lensig - 1) / 2]), lensig)
//---------------------------------//
//----------  histtogram  ---------//
//---------------------------------//
hist = macdavg - signal
//---------------------------------//
//---------------------------------//
//---------------------------------//
/////////////////////////////////////



////////////////////////////////////////
//------------------------------------//
//---------- Long term MACD ----------//
//------------------------------------//
//-----------  Long ZLEMA  -----------//
//------------------------------------//
//--------------- Fast ---------------//
//------------------------------------//
Flag2 = (lenF*mult - 1) / 2
Fdata2 = src + (src - src[Flag])
fast2 = ema(Fdata, lenF*mult)
//------------------------------------//
//--------------- Slow ---------------//
//------------------------------------//
Slag2 = (lenS*mult - 1) / 2
Sdata2 = src + (src - src[Slag])
slow2 = ema(Sdata2, lenS*mult)
//------------------------------------//
//--------------- MACD ---------------//
//------------------------------------//
macdlong1 = fast2 - slow2
//------------------------------------//
//------------- Long EMA -------------//
//------------------------------------//
//--------------- Fast ---------------//
//------------------------------------//
emaF2 = ema(src, lenF*mult)
//------------------------------------//
//--------------- Slow ---------------//
//------------------------------------//
emaS2 = ema(src, lenS*mult)
//------------------------------------//
//--------------- MACD ---------------//
//------------------------------------//
macdlong2 = emaF - emaS
//------------------------------------//
//------------- Long KAMA ------------//
//------------------------------------//
//--------------- Fast ---------------//
//------------------------------------//
volalong1 = sum(abs(src - src[1]), lenF*mult)
erlong1 = volalong1 != 0 ? abs(src - src[lenF*mult]) / volalong1 : 0
kamaFlong = 0.0
kamaFlong:= nz(kamaFlong[1]) + pow(erlong1 * (2 / (kamalenF + 1) - 2 / (kamalenS + 1)) + 2 / (kamalenS + 1), 2) * (src - nz(kamaFlong[1]))
//------------------------------------//
//--------------- Slow ---------------//
//------------------------------------//
volalong2 = sum(abs(src - src[1]), lenS*mult)
erlong2 = volalong2 != 0 ? abs(src - src[lenS*mult]) / volalong2 : 0
kamaSlong = 0.0
kamaSlong:= nz(kamaSlong[1]) + pow(erlong2 * (2 / (kamalenF + 1) - 2 / (kamalenS + 1)) + 2 / (kamalenS + 1), 2) * (src - nz(kamaSlong[1]))
//------------------------------------//
//--------------- MACD ---------------//
//------------------------------------//
macdlong3 = kamaFlong - kamaSlong
//------------------------------------//
//----- 3 average long term MACD -----//
//------------------------------------//
macdavglong = (macdlong1 + macdlong2 + macdlong3) / 3
//------------------------------------//
//------------------------------------//
//------------------------------------//
////////////////////////////////////////



///////////////////////////////
//---------------------------//
//---------- Cross ----------//
//---------------------------//
buy = crossover(macdavg, signal)
sell = crossunder(macdavg, signal)
over0 = crossover(macdavg, 0)
under0=crossunder(macdavg, 0)
//---------------------------//
//---------------------------//
//---------------------------//
///////////////////////////////



/////////////////////////////////////
//---------------------------------//
//------------- colors ------------//
//---------------------------------//
col_grow_above = #FF3F00
col_grow_below = #99CCFF
col_fall_above = #FF9999
col_fall_below = #007FFF
//---------------------------------//
//---------------------------------//
//---------------------------------//
/////////////////////////////////////



//////////////////////////////////////////////////
//----------------------------------------------//
//-------------------- Plot --------------------//
//----------------------------------------------//
plot(macd2, title="Normal MACD", transp=0, color=yellow,style=circles, linewidth=2)
plot(macdavg, title="3 Average MACD", color=#FF7F00, transp=0, linewidth=3)
plot(signal, title="Smoothing of 3 Avgrage MACD", color=#BFFF00, transp=50, linewidth=1)
plot(hist, title="Histogram", style=columns, color=(hist>=0 ? (hist[1] < hist ? col_grow_above : col_fall_above) : (hist[1] < hist ? col_grow_below : col_fall_below) ), transp=50)
plot(macdavglong, title="Long term 3 average MACD", color=#FF658C, transp=0, linewidth=1)
//----------------------------------------------//
//----------------------------------------------//
//----------------------------------------------//
//////////////////////////////////////////////////



////////////////////////////////////////////////////////
//----------------------------------------------------//
//-------------------- Plot Shape --------------------//
//----------------------------------------------------//
plotshape(sell, title="Dead cross", color=#65D8FF, style=shape.xcross, text="DX🐹💦", textcolor=white, location=location.top,transp=40)
plotshape(buy, title="Golden cross", color=#FF6565, style=shape.xcross, text="GX👴🏻💢", textcolor=white, location=location.bottom, transp=40)
plotshape(over0, title="crossover 0 line", color=#FF6565, style=shape.arrowup, text="over 0", location=location.top, transp=0)
plotshape(under0, title="crossunder 0 line", color=#65D8FF, style=shape.arrowdown, text="under 0", location=location.bottom, transp=0)
//----------------------------------------------------//
//----------------------------------------------------//
//----------------------------------------------------//
////////////////////////////////////////////////////////